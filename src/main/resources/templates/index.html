<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="/css/board.css">
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"/>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
        crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
          crossorigin="anonymous"></script>
  <title>Trello</title>
  <style>
    .offcanvas {
      position: fixed;
      top: 0;
      bottom: 0;
      z-index: 1050;
      display: none;
      padding: 1rem;
      overflow-y: auto;
      background-color: rgba(236, 234, 238, 0.6);
    }

    .offcanvas.show {
      display: block;
    }

    /* 모달 배경 */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      align-items: center;
      justify-content: center;
    }

    /* 모달 내용 */
    .modal-content {
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.3);
    }

    /* 모달 닫기 버튼 */
    .close {
      position: absolute;
      top: 10px;
      right: 10px;
      cursor: pointer;
    }

    /* 모달 내용의 입력 폼 스타일링 */
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    input[type="text"],
    textarea,
    input[type="color"],
    button[type="submit"] {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 16px;
    }

    button[type="submit"] {
      background-color: #007bff;
      color: #fff;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
<!-- Trello Clone -->
<div class="app">
  <!-- Main Header -->
  <header class="app-header">
    <div class="left">
      <div class="btn"><i class="fas fa-home"></i></div>
      <button class="btn btn-primary" type="button" data-bs-toggle="offcanvas"
              data-bs-target="#offcanvasWithBothOptions" aria-controls="offcanvasWithBothOptions">
        <i class="fab fa-trello"></i> Boards
      </button>
      <div class="btn search">
        Search
        <i class="fas fa-search"></i>
      </div>
    </div>

    <div class="offcanvas offcanvas-start" data-bs-scroll="true" tabindex="-1"
         id="offcanvasWithBothOptions" aria-labelledby="offcanvasWithBothOptionsLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasWithBothOptionsLabel">Trello</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"
                aria-label="Close"></button>
      </div>
      <div class="offcanvas-body">
        <p>여기에 보드 리스트들 해놓고 누르면 화면이 아예 해당 보드로 바뀌도록</p>
      </div>
    </div>

    <div class="center">
      <div class="logo"><i class="fab fa-trello"></i> Trello</div>
    </div>
    <div class="right">
      <div class="btn" id="addBoardBtn"><i class="fas fa-plus"> create</i></div>
      <!-- 모달 창 -->
      <div id="myModal" class="modal">
        <div class="modal-content">
          <span class="close">&times;</span>
          <form id="boardForm">
            <label for="boardAddTitle">보드 제목:</label>
            <input type="text" id="boardAddTitle" name="boardAddTitle">

            <label for="boardAddDescription">보드 설명:</label>
            <textarea id="boardAddDescription" name="boardAddDescription"></textarea>

            <label for="boardAddColor">보드 색상:</label>
            <input type="color" id="boardAddColor" name="boardAddColor">

            <button type="submit">보드 생성</button>
          </form>
        </div>
      </div>

      <div class="btn"><i class="fas fa-info-circle"></i></div>
      <div class="btn"><i class="far fa-bell"></i></div>
      <div class="btn"><i class="fas fa-cog"></i></div>
      <div class="btn"><i class="fas fa-user-tie"></i></div>
    </div>
  </header>

  <!-- App Board -->
  <main class="app-board">
    <header class="board-header">
      <div class="left">
        <div class="title" id="boardTitle"></div>
        <div class="btn btn-member"><i class="fa-solid fa-user-group"></i></div>
        <div class="btn btn-edit-board" data-bs-toggle="modal" data-bs-target="#editBoardModal"><i
            class="fa-solid fa-pen-to-square"></i></div>
        <!-- 모달 창 -->
        <div class="modal" id="editBoardModal">
          <div class="modal-content">
            <span class="close">&times;</span>
            <form id="editBoardForm">
              <label for="editBoardTitle">보드 제목:</label>
              <input type="text" id="editBoardTitle" name="editBoardTitle">

              <label for="editBoardDescription">보드 설명:</label>
              <textarea id="editBoardDescription" name="editBoardDescription"></textarea>

              <label for="editBoardColor">보드 색상:</label>
              <input type="color" id="editBoardColor" name="editBoardColor">

              <button type="submit">보드 수정</button>
            </form>
          </div>
        </div>

        <div class="btn btn-delete-board"><i class="fa-solid fa-trash"></i></div>
      </div>
      <div class="right">
        <div class="btn btn-text"><i class="fas fa-male"></i> Butler</div>
        <div class="btn btn-text"><i class="fas fa-ellipsis-h"></i> Menu</div>
      </div>
    </header>

    <!-- Board -->
    <section class="board-body">
      <div class="wrap-lists">
        <div class="board-col">
          <div class="list">
            <h4 class="list-title">List title</h4>
            <div class="card">Card 1</div>
            <a class="btn-list" href="#">+ Add another card</a>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- App Tint -->
  <div class="app-tint">
    <input type="color" id="app-color">
    <label for="app-color"><i class="fas fa-tint"></i></label>
  </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.10.2/umd/popper.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.5.0/js/bootstrap.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', async function () {
    document.cookie.replace("jwt=", "Bearer ");
    try {
      const isBoardMemberExist = await isBoardExist(); // 비동기 함수 호출 및 완료 대기
      const memberCount = isBoardMemberExist.memberCount;
      const firstBoardId = isBoardMemberExist.firstMemberBoardId;
      if (memberCount != 0) {
        // 첫번째 보드 불러오기
        await fetchBoardDetails(firstBoardId);
        // 보드 리스트들도 불러오기
        await getBoardListInOffcanvas();
      } else {
        await initPostOneBoard()
        .then(async () => {
          const newBoardMember = await isBoardExist();
          const newBoardId = newBoardMember.firstMemberBoardId;
          // 첫번째 보드 불러오기
          await fetchBoardDetails(newBoardId);
          // 보드 리스트들도 불러오기
          await getBoardListInOffcanvas();
        })
        .catch(error => {
          console.error('initOneBoardPost 실행 중 오류:', error);
        });
      }
    } catch (error) {
      console.error('isBoardExist 함수에서 문제가 있습니다. ', error);
    }

    const offcanvas = new bootstrap.Offcanvas(document.getElementById('offcanvasWithBothOptions'));
    const offcanvasTrigger = document.querySelector('[data-bs-toggle="offcanvas"]');

    offcanvasTrigger.addEventListener('click', function () {
      if (!offcanvas.isShown) {
        offcanvas.show();
      } else {
        offcanvas.hide();
      }
    });
  });

  async function isBoardExist() {
    try {
      const req = await fetch('/api/board/getMembers', {
        credentials: 'same-origin',
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        },
      });

      if (req.ok) {
        const members = await req.json();
        const memberCount = members.length;

        if (memberCount > 0) {
          const firstMember = members[0];
          const firstMemberBoardId = firstMember.board_id;

          return {
            memberCount: memberCount,
            firstMemberBoardId: firstMemberBoardId
          };
        } else {
          return {
            memberCount: 0,
            firstMemberBoardId: null
          };
        }
      } else {
        console.error('Failed to fetch board members.');
        return {
          memberCount: 0,
          firstMemberBoardId: null
        };
      }
    } catch (error) {
      console.error('An error occurred:', error);
      return {
        memberCount: 0,
        firstMemberBoardId: null
      };
    }
  }

  async function initPostOneBoard() {

    var title = "Init Board";
    var description = "Init Description";
    var color = "#000000";

    var requestData = {
      // createBoardRequestDto에 필요한 데이터를 여기에 추가
      "title": title,
      "description": description,
      "color": color
    };

    try {
      const response = await $.ajax({
        type: "POST",
        url: "/api/board",
        contentType: "application/json",
        data: JSON.stringify(requestData),
        xhrFields: {
          withCredentials: true // 쿠키 포함
        }
      });

      $("#myModal").css("display", "none");

    } catch (error) {
      alert("오류: " + error.responseText);
    }
  }

  // 보드 리스트 받아오는 메서드
  async function getBoardListInOffcanvas() {
    try {
      const response = await fetch('/api/boards', {
        credentials: 'same-origin',
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        },
      });
      const data = await response.json();
      const username = extractUserIdFromJwtCookie(); // 현재 로그인한 사용자의 아이디 추출

      const userIdFromUsername = await fetch('/api/board/' + username, {
        credentials: 'same-origin',
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        },
      });

      const userIdFromUsernameData = await userIdFromUsername.json(); // JSON 데이터로 변환

      const offcanvasBody = document.querySelector('.offcanvas-body');
      offcanvasBody.innerHTML = ''; // 기존 내용을 비우고 다시 추가

      data.forEach(board => {
        const boardCol = document.createElement('div');
        boardCol.className = 'list';
        const boardButton = document.createElement('button');
        boardButton.className = 'btn btn-primary';
        boardButton.type = 'button';
        boardButton.dataset.boardId = board.id;
        boardButton.dataset.userId = board.user_id; // userId 추가
        boardButton.textContent = board.title;

        if (userIdFromUsernameData === board.user_id) {
          boardButton.textContent += ` (ADMIN)`;
        } else {
          boardButton.textContent += ` (MEMBER)`;
        }

        boardCol.appendChild(boardButton);
        offcanvasBody.appendChild(boardCol);
      });

      const boardButtons = document.querySelectorAll('.offcanvas-body button');
      boardButtons.forEach(button => {
        button.addEventListener('click', () => {
          const boardId = button.dataset.boardId;
          const userId = button.dataset.userId; // userId 사용
          fetchBoardDetails(boardId, userId); // fetchBoardDetails에 userId도 전달
        });
      });

      return data; // 데이터 반환
    } catch (error) {
      console.error('Error fetching board list:', error);
      return []; // 에러 발생 시 빈 배열 반환
    }
  }

  // 보드 하나 받아오는 메서드
  async function fetchBoardDetails(boardId) {
    try {
      const boardDetails = await fetch(`/api/boards/${boardId}`, {
        credentials: 'same-origin',
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        },
      })
      .then(response => response.json())
      .then(data => {
        const boardTitle = document.getElementById('boardTitle');
        boardTitle.textContent = `${data.title}`;

        console.log("밖에 " + data.id);

        // .btn-edit-board 버튼에 대한 클릭 이벤트 핸들러
        $(".btn-edit-board").off("click").click(async function () {
          const dataId = data.id; // data.id 값을 가져옴
          $("#editBoardModal").css("display", "block");
          await modifyCurrentBoard(dataId);
        });

        // .btn-edit-board 버튼에 대한 클릭 이벤트 핸들러
        $(".btn-delete-board").off("click").click(async function () {
          const currId = data.id;
          await deleteCurrentBoard(currId);
        });

        const color = data.color;
        root.style.setProperty('--app-col', color);

        const boardBody = document.querySelector('.board-body');
        boardBody.innerHTML = ''; // 기존 내용을 비우고 다시 추가

        const wrapLists = document.createElement('div');
        wrapLists.className = 'wrap-lists';

        data.columns.forEach(column => {
          const boardCol = document.createElement('div');
          boardCol.className = 'board-col';

          const list = document.createElement('div');
          list.className = 'list';

          const listTitle = document.createElement('h4');
          listTitle.className = 'list-title';
          listTitle.textContent = column.title;
          list.appendChild(listTitle);

          column.cardList.forEach(card => {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'card';
            cardDiv.textContent = card.title; // 카드의 제목을 표시
            list.appendChild(cardDiv);
          });

          const addCardLink = document.createElement('a');
          addCardLink.className = 'btn-list';
          addCardLink.href = '#';
          addCardLink.textContent = '+ Add another card';
          list.appendChild(addCardLink);

          boardCol.appendChild(list);
          wrapLists.appendChild(boardCol);
        });

        const addListCol = document.createElement('div');
        addListCol.className = 'board-col';
        const addListLink = document.createElement('a');
        addListLink.className = 'btn-list';
        addListLink.href = '#';
        addListLink.textContent = '+ Add another list';
        addListCol.appendChild(addListLink);
        wrapLists.appendChild(addListCol);

        const boardSection = document.createElement('section');
        boardSection.className = 'board-body';
        boardSection.appendChild(wrapLists);
        boardBody.appendChild(boardSection);
      })
      .catch(error => console.error('Error fetching board details:', error));

      if (boardDetails && boardDetails.ok) {
        window.location.href = '/web';
      }
    } catch (error) {
      console.error('Error updating board details:', error);
    }
  }

  // 모달 버튼들 준비
  $(document).ready(function () {
    // 모달 열기 버튼 클릭 시
    $("#addBoardBtn").click(function () {
      $("#myModal").css("display", "block");
    });

    // 보드 수정 모달 열기 버튼 클릭 시
    // $(".btn-edit-board").click(function () {
    //   $("#editBoardModal").css("display", "block");
    // });

    // 모달 닫기 버튼 클릭 시
    $(".close").click(function () {
      $("#myModal").css("display", "none");
    });

    // 모달 외부 클릭 시 닫기
    $(window).click(function (event) {
      if (event.target.id === "myModal") {
        $("#myModal").css("display", "none");
      }
    });

    // 수정 모달 닫기 버튼 클릭 시
    $(".close").click(function () {
      $("#editBoardModal").css("display", "none");
      $(".modal-backdrop").remove(); // 모달 백드롭을 제거합니다
      $(".modal").removeClass("show"); // 모든 모달의 'show' 클래스를 제거합니다
    });

    // 수정 모달 외부 클릭 시 닫기
    $(window).click(function (event) {
      if (event.target.id === "editBoardModal") {
        $("#editBoardModal").css("display", "none");
        $(".modal-backdrop").remove(); // 모달 백드롭을 제거합니다
        $(".modal").removeClass("show"); // 모든 모달의 'show' 클래스를 제거합니다
      }
    });
  });

  // 보드 생성 모달창 -> 보드 생성하는 로직
  $("#boardForm").submit(async function (event) {
    event.preventDefault(); // Prevent default form submission behavior

    // Get values from form inputs
    const title = $("#boardAddTitle").val();
    const description = $("#boardAddDescription").val();
    const color = $("#boardAddColor").val();

    // Create a request data object
    const requestData = {
      "title": title,
      "description": description,
      "color": color
    };

    try {
      const response = await $.ajax({
        type: "POST",
        url: "/api/board", // Replace with your API endpoint
        contentType: "application/json",
        data: JSON.stringify(requestData),
        xhrFields: {
          withCredentials: true // Include cookies
        }
      });

      // Close the modal after successful submission
      $("#myModal").css("display", "none");

      // Optionally, you can fetch and update the board list or perform other actions here
    } catch (error) {
      alert("Error: " + error.responseText);
    } finally {
      const newCreateBoardMember = await isBoardExist();
      const newCreateBoardId = newCreateBoardMember.firstMemberBoardId;
      // 첫번째 보드 불러오기
      await fetchBoardDetails(newCreateBoardId);
      // 보드 리스트들도 불러오기
      await getBoardListInOffcanvas();
    }
  });

  // 쿠키 현재 로그인한 유저 아이디 뽑기 (sub에 있음 -> 한글, 영어다 디코딩 되도록 -> 카카오 이슈)
  function extractUserIdFromJwtCookie() {
    // 현재 쿠키 문자열을 가져옵니다.
    const cookieString = document.cookie;

    // 쿠키가 비어있다면 null을 반환합니다.
    if (!cookieString) {
      return null;
    }

    // 쿠키 문자열을 세미콜론(;)으로 분리하여 각 쿠키 항목을 배열로 만듭니다.
    const cookieItems = cookieString.split(';');

    // "Authorization" 쿠키 값을 찾습니다.
    let authCookieValue = null;
    for (const item of cookieItems) {
      const trimmedItem = item.trim();
      if (trimmedItem.startsWith("Authorization=")) {
        authCookieValue = trimmedItem.substr("Authorization=".length);
        break;
      }
    }

    // "Authorization" 쿠키가 없으면 null을 반환합니다.
    if (!authCookieValue) {
      return null;
    }

    // 쿠키 값에서 "Bearer " 부분을 제거합니다.
    const jwtToken = authCookieValue.replace("Bearer ", "");

    try {
      // JWT 디코딩
      const [, payloadBase64] = jwtToken.split('.');
      const decodedPayload = decodeURIComponent(escape(atob(jwtToken.split('.')[1])));

      const payloadObj = JSON.parse(decodedPayload);

      if (payloadObj && payloadObj.sub) {
        return payloadObj.sub;
      } else {
        return null;
      }
    } catch (error) {
      console.error('JWT 디코딩 오류:', error);
      return null;
    }
  }

  // 앱 색깔 지정하는 부분 -> 근데 이게 없으면 수정이나 생성에서도 색깔 반영이 안됨
  const root = document.documentElement,
      colorIn = document.getElementById('app-color');

  // Color selection
  colorIn.addEventListener('input', function () {
    const color = this.value;
    root.style.setProperty('--app-col', color);
  });
  // ---------------------------------------

  async function modifyCurrentBoard (currentBoardId) {
    console.log("함수 안 : " + currentBoardId);
    $("#editBoardModal").submit(async function (event) {
      console.log("함수 안의 안 : " + currentBoardId);
      event.preventDefault(); // Prevent default form submission behavior
      const editBoardTitle = $("#editBoardTitle").val();
      const editBoardDescription = $("#editBoardDescription").val();
      const editBoardColor = $("#editBoardColor").val();

      // 모달 폼 데이터를 백엔드로 전송
      try {
        const response = await fetch(`/api/board/` + currentBoardId, {
          method: 'PUT',
          credentials: 'same-origin',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            title: editBoardTitle,
            description: editBoardDescription,
            color: editBoardColor
          })
        });

        if (response.ok) {
          // 백엔드로 데이터 전송 성공 시 UI 업데이트 등의 작업을 수행합니다.
          console.log('Board data sent successfully.');
          // 모달을 닫습니다.
          $("#editBoardModal").css("display", "none");
          $(".modal-backdrop").remove(); // 모달 백드롭을 제거합니다
          $(".modal").removeClass("show"); // 모든 모달의 'show' 클래스를 제거합니다
        } else {
          console.error('Failed to send board data.');
        }
      } catch (error) {
        console.error('Error sending board data:', error);
      } finally {
        await fetchBoardDetails(currentBoardId);
        // 보드 리스트들도 불러오기
        await getBoardListInOffcanvas();
      }
    });
  }

  async function deleteCurrentBoard(currBoardId) {
    try {
      console.log("삭제 로직 안 : " + currBoardId);
      const response = await fetch(`/api/board/` + currBoardId, {
        method: 'DELETE',
        credentials: 'same-origin',
        headers: {
          'Content-Type': 'application/json'
        }
      });

      if (response.ok) {
        // 백엔드로 데이터 전송 성공 시 UI 업데이트 등의 작업을 수행합니다.
        console.log('Board delete successfully.');
      } else {
        console.error('Failed to send board data.');
      }
    } catch (error) {
      console.error('Error sending board data:', error);
    } finally {
      window.location.href = '/web';
    }
  }

</script>
</body>
</html>