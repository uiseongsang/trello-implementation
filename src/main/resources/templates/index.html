<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="/css/board.css">
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"/>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
        crossorigin="anonymous">

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
          crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>
  <title>Trello</title>
  <style>
    .offcanvas {
      position: fixed;
      top: 0;
      bottom: 0;
      z-index: 1050;
      display: none;
      padding: 1rem;
      overflow-y: auto;
      background-color: rgba(236, 234, 238, 0.6);
    }

    .offcanvas.show {
      display: block;
    }

    /* 모달 배경 */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      align-items: center;
      justify-content: center;
    }

    /* 모달 내용 */
    .modal-content {
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.3);
    }

    /* 모달 닫기 버튼 */
    .close {
      position: absolute;
      top: 10px;
      right: 10px;
      cursor: pointer;
    }

    /* 모달 내용의 입력 폼 스타일링 */
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    input[type="text"],
    textarea,
    input[type="color"],
    button[type="submit"] {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 16px;
    }

    button[type="submit"] {
      background-color: #007bff;
      color: #fff;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
<!-- Trello Clone -->
<div class="app">
  <!-- Main Header -->
  <header class="app-header">
    <div class="left">
      <div class="btn"><i class="fas fa-home"></i></div>
      <button class="btn btn-primary" type="button" data-bs-toggle="offcanvas"
              data-bs-target="#offcanvasWithBothOptions" aria-controls="offcanvasWithBothOptions">
        <i class="fab fa-trello"></i> Boards
      </button>
      <div class="btn search">
        Search
        <i class="fas fa-search"></i>
      </div>
    </div>

    <div class="offcanvas offcanvas-start" data-bs-scroll="true" tabindex="-1"
         id="offcanvasWithBothOptions" aria-labelledby="offcanvasWithBothOptionsLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasWithBothOptionsLabel">Trello</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"
                aria-label="Close"></button>
      </div>
      <div class="offcanvas-body">
        <p>여기에 보드 리스트들 해놓고 누르면 화면이 아예 해당 보드로 바뀌도록</p>
      </div>
    </div>

    <div class="center">
      <div class="logo"><i class="fab fa-trello"></i> Trello</div>
    </div>
    <div class="right">
      <div class="btn" id="addBoardBtn"><i class="fas fa-plus"> create</i></div>
      <!-- 모달 창 -->
      <div id="myModal" class="modal">
        <div class="modal-content">
          <span class="close">&times;</span>
          <form id="boardForm">
            <label for="boardAddTitle">보드 제목:</label>
            <input type="text" id="boardAddTitle" name="boardAddTitle">

            <label for="boardAddDescription">보드 설명:</label>
            <textarea id="boardAddDescription" name="boardAddDescription"></textarea>

            <label for="boardAddColor">보드 색상:</label>
            <input type="color" id="boardAddColor" name="boardAddColor">

            <button type="submit">보드 생성</button>
          </form>
        </div>
      </div>

      <div class="btn"><i class="fas fa-info-circle"></i></div>
      <div class="btn"><i class="far fa-bell"></i></div>
      <div class="btn"><i class="fas fa-cog"></i></div>
      <a href="/api/my-page"><div class="btn"><i class="fas fa-user-tie"></i></div></a>
    </div>
  </header>

  <!-- App Board -->
  <main class="app-board">
    <header class="board-header">
      <div class="left">
        <div class="title" id="boardTitle"></div>
        <div class="btn btn-member"><i class="fa-solid fa-user-group"></i></div>
        <div class="btn btn-edit-board" data-bs-toggle="modal" data-bs-target="#editBoardModal"><i class="fa-solid fa-pen-to-square"></i></div>
        <!-- 모달 창 -->
        <div class="modal" id="editBoardModal">
          <div class="modal-content">
            <span class="close">&times;</span>
            <form id="editBoardForm">
              <label for="editBoardTitle">보드 제목:</label>
              <input type="text" id="editBoardTitle" name="editBoardTitle">

              <label for="editBoardDescription">보드 설명:</label>
              <textarea id="editBoardDescription" name="editBoardDescription"></textarea>

              <label for="editBoardColor">보드 색상:</label>
              <input type="color" id="editBoardColor" name="editBoardColor">

              <button type="submit">보드 수정</button>
            </form>
          </div>
        </div>

        <div class="btn btn-delete-board"><i class="fa-solid fa-trash"></i></div>
      </div>
      <div class="right">
        <div class="btn btn-text"><i class="fas fa-male"></i> Butler</div>
        <div class="btn btn-text"><i class="fas fa-ellipsis-h"></i> Menu</div>
      </div>
    </header>

    <!-- Board -->
    <section class="board-body">
      <div class="wrap-lists">
        <div class="board-col">
          <div class="list">
            <h4 class="list-title">List title</h4>
            <div class="card">Card 1</div>
            <a class="btn-list" href="#">+ Add another card</a>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- App Tint -->
  <div class="app-tint">
    <input type="color" id="app-color">
    <label for="app-color"><i class="fas fa-tint"></i></label>
  </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.10.2/umd/popper.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.5.0/js/bootstrap.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    document.cookie.replace("jwt=", "Bearer ");
    getBoardListInOffcanvas().then(data => {
      if (data.length > 0) {
        const firstBoardId = data[0].id;
        fetchBoardDetails(firstBoardId);
      }
    });

    const offcanvas = new bootstrap.Offcanvas(document.getElementById('offcanvasWithBothOptions'));
    const offcanvasTrigger = document.querySelector('[data-bs-toggle="offcanvas"]');

    offcanvasTrigger.addEventListener('click', function () {
      if (!offcanvas.isShown) {
        offcanvas.show();
      } else {
        offcanvas.hide();
      }
    });

    let isCreatingBoard = false; // 보드 생성 중인지 여부

    $("#boardForm").submit(async function (event) {
      event.preventDefault();

      if (isCreatingBoard) {
        return; // 이미 보드 생성 중이면 중복 요청 방지
      }

      isCreatingBoard = true;

      var title = $("#boardAddTitle").val();
      var description = $("#boardAddDescription").val();
      var color = $("#boardAddColor").val();

      var requestData = {
        // createBoardRequestDto에 필요한 데이터를 여기에 추가
        "title": title,
        "description": description,
        "color": color
      };

      try {
        const response = await $.ajax({
          type: "POST",
          url: "/api/board",
          contentType: "application/json",
          data: JSON.stringify(requestData),
          xhrFields: {
            withCredentials: true // 쿠키 포함
          }
        });

        alert("Board 생성 성공");
        $("#myModal").css("display", "none");

        // 생성된 보드의 ID를 사용하여 해당 보드의 상세 내용 가져오기
        fetchBoardDetailsAndUpdateList(response.id);

      } catch (error) {
        alert("오류: " + error.responseText);
      } finally {
        isCreatingBoard = false;
      }
    });
  });

  async function fetchBoardDetailsAndUpdateList(boardId) {
    try {
      await fetchBoardDetails(boardId);
      await updateBoardList();
    } catch (error) {
      console.error('Error fetching board details and updating list:', error);
    }
  }

  async function updateBoardList(newBoardId) {
    try {
      const data = await getBoardListInOffcanvas();

      // 새로 생성된 보드 ID를 사용하여 해당 보드의 상세 내용 가져오기
      fetchBoardDetails(newBoardId);
    } catch (error) {
      console.error('Error updating board list:', error);
    }
  }

  async function getBoardListInOffcanvas() {
    try {
      const response = await fetch('/api/boards', {
        credentials: 'same-origin',
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        },
      });
      const data = await response.json();
      const username = extractUserIdFromJwtCookie(); // 현재 로그인한 사용자의 아이디 추출

      const userIdFromUsername = await fetch('/api/board/' + username, {
        credentials: 'same-origin',
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        },
      });

      const userIdFromUsernameData = await userIdFromUsername.json(); // JSON 데이터로 변환

      const offcanvasBody = document.querySelector('.offcanvas-body');
      offcanvasBody.innerHTML = ''; // 기존 내용을 비우고 다시 추가

      data.forEach(board => {
        const boardCol = document.createElement('div');
        boardCol.className = 'list';
        const boardButton = document.createElement('button');
        boardButton.className = 'btn btn-primary';
        boardButton.type = 'button';
        boardButton.dataset.boardId = board.id;
        boardButton.dataset.userId = board.user_id; // userId 추가
        boardButton.textContent = board.title;

        if (userIdFromUsernameData === board.user_id) boardButton.textContent += ` (ADMIN)`;
        else boardButton.textContent += ` (MEMBER)`;

        boardCol.appendChild(boardButton);
        offcanvasBody.appendChild(boardCol);
      });

      const boardButtons = document.querySelectorAll('.offcanvas-body button');
      boardButtons.forEach(button => {
        button.addEventListener('click', () => {
          const boardId = button.dataset.boardId;
          const userId = button.dataset.userId; // userId 사용
          fetchBoardDetails(boardId, userId); // fetchBoardDetails에 userId도 전달
          $(".btn-edit-board").click(function () {
            editBoardDetails(boardId);
          });
          $(".btn-delete-board").click(function () {
            deleteBoardDetails(boardId);
          });
          $(".btn-member").click(function () {
            window.location.href = '/web/boardMember/' + boardId;
          });
        });
      });

      return data; // 데이터 반환
    } catch (error) {
      console.error('Error fetching board list:', error);
      return []; // 에러 발생 시 빈 배열 반환
    }
  }

  function openModal(cardId) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.tabIndex = cardId;
    let innerHtml = ``
    fetch(`/api/card/${cardId}`, {
      credentials: 'same-origin',
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      },
    })
     .then(response => response.json())
     .then(card => {
       innerHtml += `
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" data-card-id="${card.id}">${card.title}</h5>
           <button type="button" class="btn btn-primary edit-button-title" id="editTitle${card.id}" onclick="editTitleButton(${card.id})">Edit</button>
  <button type="button" class="btn btn-primary save-button-title d-none" id="saveTitle${card.id}" onclick="saveTitleButton(${card.id})">Save</button>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="item-container">
            <label for="cardColor">Card Color:</label>
            <div class="item-content">
              <select id="cardColor" disabled>
                <option value="red">Red</option>
                <option value="blue">Blue</option>
                <option value="green">Green</option>
              </select>
              <button type="button" class="btn btn-primary edit-button" id="editColor">Edit</button>
              <button type="button" class="btn btn-primary save-button d-none" id="saveColor">Save</button>
            </div>
          </div>

          <div class="item-container">
            <label for="dueDate">Deadline</label>
            <div class="item-content">
              <input type="datetime-local" id="dueDate" disabled>
              <button type="button" class="btn btn-primary edit-button" id="editDueDate">Edit</button>
              <button type="button" class="btn btn-primary save-button d-none" id="saveDueDate">Save</button>
            </div>
          </div>

          <div class="item-container">
            <label for="description">Description:</label>
            <div class="item-content">
              <textarea id="description" disabled>${card.description}</textarea>
              <button type="button" class="btn btn-primary edit-button" id="editDescription">Edit</button>
              <button type="button" class="btn btn-primary save-button d-none" id="saveDescription">Save</button>
            </div>
          </div>

          <div class="item-container">
            <label for="comment">Comment:</label>
            <div class="item-content">
              <input type="text" id="comment" placeholder="Enter your comment">
              <button type="button" class="btn btn-primary add-comment-button" id="addComment">Add Comment</button>
            </div>
          </div>

            <div class="item-container">
            <label for="commentList">Comments:</label>
            <div class="item-content" id="commentList">
              <!-- 댓글 목록이 여기에 표시될 것입니다. -->

  `;
       // 모달 댓글 목록 추가

       if(card.commentList.length > 0) {
         for (let comment of card.commentList) {
           innerHtml += `
          <div class="commentInfo${comment.id}">
      <p>${comment.content}</p>
      <div class="commentButtons">
        <button type="button" class="btn btn-sm btn-primary edit-comment-button" data-comment-id="${comment.id}">Edit</button>
        <button type="button" class="btn btn-sm btn-danger delete-comment-button" data-comment-id="${comment.id}">Delete</button>
      </div>
    </div>
         `
         }
       }

       // 모달 푸터 추가
       innerHtml += `
            </div>
          </div>
        </div>
       <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-danger" id="delete-card-Button" onclick="deleteCard(${card.columnNo}, ${card.id})">Delete</button>
        </div>
      </div>
    </div>
       `
        modal.innerHTML += innerHtml;
       // 모달을 body에 추가
       document.body.appendChild(modal);

       // 모달을 열기 위한 이벤트 리스너 추가
       modal.addEventListener('shown.bs.modal', () => {
         modal.classList.add('show');
       });

       modal.addEventListener('shown.bs.modal', () => {
         const colorSelect = modal.querySelector('#cardColor');
         if (card.color == null || card.color) {
           colorSelect.value = card.color;
         }

         // "deadline" 값이 datetime-local 입력란에 대입
         const deadlineInput = modal.querySelector('#dueDate');
         if (card.deadline) {
           deadlineInput.value = card.deadline;
         }
       });

       // 모달이 닫힐 때 제거
       modal.addEventListener('hidden.bs.modal', () => {
         document.body.removeChild(modal);
       });

       // 모달 열기
       const bootstrapModal = new bootstrap.Modal(modal);
       bootstrapModal.show();

       // Edit 버튼 클릭 시 처리
       const editButtons = modal.querySelectorAll('.edit-button');
       editButtons.forEach(editButton => {
         editButton.addEventListener('click', () => {
           const container = editButton.parentElement;
           const saveButton = container.querySelector('.save-button');
           saveButton.classList.remove('d-none');
           editButton.classList.add('d-none');
           const inputElement = container.querySelector('input, select, textarea'); // textarea 추가
           inputElement.removeAttribute('disabled');
           inputElement.removeAttribute('readonly'); // readonly 제거
         });
       });


       modal.addEventListener('click', event => {
         if (event.target.classList.contains('edit-comment-button')) {
           const commentId = event.target.getAttribute('data-comment-id');
           const commentElement = modal.querySelector(`.commentInfo${commentId}`);
           const commentTextElement = commentElement.querySelector('p');
           const editInput = document.createElement('input');
           editInput.type = 'text';
           editInput.value = commentTextElement.textContent;

           const saveButton = document.createElement('button');
           saveButton.type = 'button';
           saveButton.classList.add('btn', 'btn-sm', 'btn-primary', 'save-comment-button');
           saveButton.textContent = 'Save';
           saveButton.setAttribute('data-comment-id', commentId); // 여기서 추가

           commentTextElement.replaceWith(editInput);
           commentElement.querySelector('.commentButtons').appendChild(saveButton);

           event.target.style.display = 'none';
         } else if (event.target.classList.contains('delete-comment-button')) {
           const commentId = event.target.getAttribute('data-comment-id');
           const commentElement = modal.querySelector(`.commentInfo${commentId}`);

           fetch(`/api/comment/${commentId}`, {
             credentials: 'same-origin',
             method: 'DELETE',
             headers: {
               'Content-Type': 'application/json'
             },
           })
                   .then(response => {
                     if (response.statusCode == 200) {
                       alert('Color updated successfully');
                       // 여기서 다른 필요한 작업을 수행할 수 있습니다.
                     }
                   })
                   .catch(error => {
                     console.error('An error occurred:', error);
                   });
           commentElement.remove();
         } else if (event.target.classList.contains('save-comment-button')) {
           const commentId = event.target.getAttribute('data-comment-id');
           const commentElement = event.target.closest(`.commentInfo${commentId}`);
           const editInput = commentElement.querySelector('input');
           const updatedComment = editInput.value.trim();
           if (updatedComment !== '') {
             fetch(`/api/comment/${commentId}`, {
               credentials: 'same-origin',
               method: 'PATCH',
               body: JSON.stringify({ content: updatedComment }), // 객체를 JSON 문자열로 변환
               headers: {
                 'Content-Type': 'application/json'
               },
             })
                     .then(response => {
                       if (response.statusCode == 201) {
                         alert('Color updated successfully');
                         // 여기서 다른 필요한 작업을 수행할 수 있습니다.
                       }
                     })
                     .catch(error => {
                       console.error('An error occurred:', error);
                     });

             // 댓글 업데이트 후 UI 업데이트
             const commentTextElement = document.createElement('p');
             commentTextElement.textContent = updatedComment;

             editInput.replaceWith(commentTextElement);
             commentElement.querySelector('.edit-comment-button').style.display = 'inline-block';
             event.target.remove(); // 저장 버튼 제거
           }
         }
       });

       const addCommentButton = modal.querySelector('#addComment');
       const commentList = modal.querySelector('#commentList');
       addCommentButton.addEventListener('click', () => {
         const commentInput = modal.querySelector('#comment');
         const comment = commentInput.value.trim();
         if (comment !== '') {
           const commentElement = document.createElement('div');
           commentElement.className = 'comment';
           commentElement.textContent = comment;
           fetch(`/api/card/${cardId}/comment`, {
             credentials: 'same-origin',
             method: 'POST',
             body: JSON.stringify({ content: comment }), // 객체를 JSON 문자열로 변환
             headers: {
               'Content-Type': 'application/json'
             },
           })
                   .then(response => {
                     if (response.statusCode == 201) {
                       alert('Color updated successfully');
                       // 여기서 다른 필요한 작업을 수행할 수 있습니다.
                     }
                   })
                   .catch(error => {
                     console.error('An error occurred:', error);
                   });
           commentList.appendChild(commentElement);
           commentInput.value = '';
         }
       });

       // Save 버튼 클릭 시 처리
       const saveButtons = modal.querySelectorAll('.save-button');
       saveButtons.forEach(saveButton => {
         saveButton.addEventListener('click', () => {
           const container = saveButton.parentElement;
           const editButton = container.querySelector('.edit-button');
           editButton.classList.remove('d-none');
           saveButton.classList.add('d-none');
           const inputElement = container.querySelector('input, select, textarea');
           inputElement.setAttribute('disabled', true);

           // 저장 로직 추가
           if (inputElement.id === 'cardColor') {
             const cardColor = inputElement.value;
             fetch(`/api/card/${cardId}/color`, {
               credentials: 'same-origin',
               method: 'PATCH',
               body: JSON.stringify({ color: cardColor }), // 객체를 JSON 문자열로 변환
               headers: {
                 'Content-Type': 'application/json'
               },
             })
                     .then(response => {
                       if (response.statusCode == 200) {
                         alert('Color updated successfully');
                         // 여기서 다른 필요한 작업을 수행할 수 있습니다.
                       }
                     })
                     .catch(error => {
                       console.error('An error occurred:', error);
                     });
           } else if (inputElement.id === 'dueDate') {
             const deadline = inputElement.value.replace('T', ' ');
             fetch(`/api/card/${cardId}/deadline`, {
               credentials: 'same-origin',
               method: 'PATCH',
               body: JSON.stringify({ deadline: deadline }), // 객체를 JSON 문자열로 변환
               headers: {
                 'Content-Type': 'application/json'
               },
             })
                     .then(response => {
                       if (response.statusCode == 200) {
                         alert('Color updated successfully');
                         // 여기서 다른 필요한 작업을 수행할 수 있습니다.
                       }
                     })
                     .catch(error => {
                       console.error('An error occurred:', error);
                     });
           } else if (inputElement.id === 'description') {
             const description = inputElement.value;
             fetch(`/api/card/${cardId}/description`, {
               credentials: 'same-origin',
               method: 'PATCH',
               body: JSON.stringify({ description: description }), // 객체를 JSON 문자열로 변환
               headers: {
                 'Content-Type': 'application/json'
               },
             })
                     .then(response => {
                       if (response.statusCode == 200) {
                         alert('Color updated successfully');
                         // 여기서 다른 필요한 작업을 수행할 수 있습니다.
                       }
                     })
                     .catch(error => {
                       console.error('An error occurred:', error);
                     });
             console.log('Description:', description);
           }
         });
       });
     })
  }

  function editTitleButton(cardId) {
    const modalTitle = document.querySelector(`[data-card-id="${cardId}"]`);
    const titleText = modalTitle.textContent;
    const titleInput = document.createElement('input');
    titleInput.type = 'text';
    titleInput.value = titleText;
    modalTitle.replaceWith(titleInput);

    const editButton = document.getElementById(`editTitle${cardId}`);
    const saveButton = document.getElementById(`saveTitle${cardId}`);
    editButton.classList.add('d-none');
    saveButton.classList.remove('d-none');
  }

  function saveTitleButton(cardId) {
    const modal = document.querySelector('.modal');
    const titleInput = modal.querySelector('input'); // 수정한 제목을 입력한 input 요소 선택
    const newTitle = titleInput.value;

    fetch(`/api/card/${cardId}/title`, {
      credentials: 'same-origin',
      method: 'PATCH',
      body: JSON.stringify({ title: newTitle }), // 객체를 JSON 문자열로 변환
      headers: {
        'Content-Type': 'application/json'
      },
    })
            .then(response => {
              if (response.statusCode == 200) {
                alert('Color updated successfully');
                // 여기서 다른 필요한 작업을 수행할 수 있습니다.
              }
            })
            .catch(error => {
              console.error('An error occurred:', error);
            });
    titleInput.classList.add('d-none'); // 입력 창 숨기기

    const editButton = document.getElementById(`editTitle${cardId}`);
    const saveButton = document.getElementById(`saveTitle${cardId}`);
    saveButton.classList.add('d-none');
    editButton.classList.remove('d-none');
    location.reload();
  }



  function fetchBoardDetails(boardId) {
    fetch(`/api/boards/${boardId}`, {
      credentials: 'same-origin',
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      },
    })
    .then(response => response.json())
    .then(data => {
      const boardTitle = document.getElementById('boardTitle');
      boardTitle.textContent = `${data.title}`;

      const color = data.color;
      root.style.setProperty('--app-col', color);

      const boardBody = document.querySelector('.board-body');
      boardBody.innerHTML = ''; // 기존 내용을 비우고 다시 추가

      const wrapLists = document.createElement('div');
      wrapLists.className = 'wrap-lists';

      data.columns.forEach(column => {
        const boardCol = document.createElement('div');
        boardCol.className = 'board-col';

        const list = document.createElement('div');
        list.className = 'list';

        const listTitle = document.createElement('h4');
        listTitle.className = 'list-title';
        listTitle.textContent = column.title;
        list.appendChild(listTitle);

        column.cardList.forEach(card => {
          const cardDiv = document.createElement('div');
          cardDiv.className = 'card';
          cardDiv.textContent = card.title; // 카드의 제목을 표시
          cardDiv.id = card.id;
          cardDiv.addEventListener('click', () => {
            openModal(card.id); // 모달을 띄우는 함수 호출
          });
          list.appendChild(cardDiv);
        });

        const addCardLink = document.createElement('a');
        addCardLink.className = 'btn-list';
        addCardLink.href = '#';
        addCardLink.textContent = '+ Add another card';
        addCardLink.id = column.id;
        list.appendChild(addCardLink);
        addCardLink.addEventListener('click', () => addCard(column.id));

        boardCol.appendChild(list);
        wrapLists.appendChild(boardCol);
      });

      const addListCol = document.createElement('div');
      addListCol.className = 'board-col';
      const addListLink = document.createElement('a');
      addListLink.className = 'btn-list';
      addListLink.href = '#';
      addListLink.textContent = '+ Add another list';
      addListCol.appendChild(addListLink);
      wrapLists.appendChild(addListCol);

      const boardSection = document.createElement('section');
      boardSection.className = 'board-body';
      boardSection.appendChild(wrapLists);
      boardBody.appendChild(boardSection);
    })
    .catch(error => console.error('Error fetching board details:', error));
  }

  $(document).ready(function () {
    // 모달 열기 버튼 클릭 시
    $("#addBoardBtn").click(function () {
      $("#myModal").css("display", "block");
    });

    // 보드 수정 모달 열기 버튼 클릭 시
    $(".btn-edit-board").click(function () {
      $("#editBoardModal").css("display", "block");
    });

    // 모달 닫기 버튼 클릭 시
    $(".close").click(function () {
      $("#myModal").css("display", "none");
    });

    // 모달 외부 클릭 시 닫기
    $(window).click(function (event) {
      if (event.target.id === "myModal") {
        $("#myModal").css("display", "none");
      }
    });

    // 수정 모달 닫기 버튼 클릭 시
    $(".close").click(function () {
      $("#editBoardModal").css("display", "none");
      $(".modal-backdrop").remove(); // 모달 백드롭을 제거합니다
      $(".modal").removeClass("show"); // 모든 모달의 'show' 클래스를 제거합니다
    });

    // 수정 모달 외부 클릭 시 닫기
    $(window).click(function (event) {
      if (event.target.id === "editBoardModal") {
        $("#editBoardModal").css("display", "none");
        $(".modal-backdrop").remove(); // 모달 백드롭을 제거합니다
        $(".modal").removeClass("show"); // 모든 모달의 'show' 클래스를 제거합니다
      }
    });

    // 폼 제출 시
    $("#boardForm").submit(async function (event) {
      event.preventDefault();

      if (isCreatingBoard) {
        return; // 이미 보드 생성 중이면 중복 요청 방지
      }

      isCreatingBoard = true;

      var title = $("#boardAddTitle").val();
      var description = $("#boardAddDescription").val();
      var color = $("#boardAddColor").val();

      var requestData = {
        // createBoardRequestDto에 필요한 데이터를 여기에 추가
        "title": title,
        "description": description,
        "color": color
      };

      try {
        const response = await $.ajax({
          type: "POST",
          url: "/api/board",
          contentType: "application/json",
          data: JSON.stringify(requestData),
          xhrFields: {
            withCredentials: true // 쿠키 포함
          }
        });

        alert("Board 생성 성공");
        $("#myModal").css("display", "none");

        // 생성된 보드의 ID를 사용하여 해당 보드의 상세 내용 가져오기
        fetchBoardDetailsAndUpdateList(response.id);
      } catch (error) {
        alert("오류: " + error.responseText);
      } finally {
        isCreatingBoard = false;
      }
    });
  });

  function extractUserIdFromJwtCookie() {
    // 현재 쿠키 문자열을 가져옵니다.
    const cookieString = document.cookie;

    // 쿠키가 비어있다면 null을 반환합니다.
    if (!cookieString) {
      return null;
    }

    // 쿠키 문자열을 세미콜론(;)으로 분리하여 각 쿠키 항목을 배열로 만듭니다.
    const cookieItems = cookieString.split(';');

    // "Authorization" 쿠키 값을 찾습니다.
    let authCookieValue = null;
    for (const item of cookieItems) {
      const trimmedItem = item.trim();
      if (trimmedItem.startsWith("Authorization=")) {
        authCookieValue = trimmedItem.substr("Authorization=".length);
        break;
      }
    }

    // "Authorization" 쿠키가 없으면 null을 반환합니다.
    if (!authCookieValue) {
      return null;
    }

    // 쿠키 값에서 "Bearer " 부분을 제거합니다.
    const jwtToken = authCookieValue.replace("Bearer ", "");

    try {
      // JWT 디코딩
      const [, payloadBase64] = jwtToken.split('.');
      const decodedPayload = JSON.parse(atob(payloadBase64));

      if (decodedPayload && decodedPayload.sub) {
        return decodedPayload.sub;
      } else {
        return null;
      }
    } catch (error) {
      console.error('JWT 디코딩 오류:', error);
      return null;
    }
  }

  const root = document.documentElement,
      colorIn = document.getElementById('app-color');

  // Color selection
  colorIn.addEventListener('input', function() {
    const color = this.value;
    root.style.setProperty('--app-col', color);
  })

  async function updateBoardDetails(boardId, updatedData) {
    try {
      const response = await fetch(`/api/board/${boardId}`, {
        credentials: 'same-origin',
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(updatedData),
      });

      if (response.ok) {
        // 텍스트 메시지 대신 알림창으로 메시지 표시
        alert('Board updated successfully');

        // 업데이트 성공 후 일정 시간(예: 1.5초) 후에 페이지 새로고침
        setTimeout(() => {
          location.reload();
        }, 1500);
      } else {
        const errorText = await response.text();
        throw new Error(`Error updating board: ${errorText}`);
      }
    } catch (error) {
      console.error('Error updating board:', error);
    }
  }

  function editBoardDetails(boardId) {

    if (!boardId) {
      console.error('Unable to determine board ID');
      return;
    }

    $("#editBoardModal").css("display", "block");

    // Submit updated board details
    $("#editBoardForm").off('submit').on('submit', async function (event) {
      event.preventDefault();

      const updatedTitle = $("#editBoardTitle").val();
      const updatedDescription = $("#editBoardDescription").val();
      const updatedColor = $("#editBoardColor").val();

      const updatedData = {
        title: updatedTitle,
        description: updatedDescription,
        color: updatedColor,
      };

      updateBoardDetails(boardId, updatedData);

      // Close the modal
      $("#editBoardModal").css("display", "none");
      $(".modal-backdrop").remove();
      $(".modal").removeClass("show");
    });
  }

  async function deleteBoardDetails(boardId) {
    try {
      const response = await fetch(`/api/board/${boardId}`, {
        credentials: 'same-origin',
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
        },
      });

      if (response.ok) {
        // 텍스트 메시지 대신 알림창으로 메시지 표시
        alert('Board delete successfully');

        // 업데이트 성공 후 일정 시간(예: 1.5초) 후에 페이지 새로고침
        setTimeout(() => {
          location.reload();
        }, 1500);
      } else {
        const errorText = await response.text();
        throw new Error(`Error updating board: ${errorText}`);
      }
    } catch (error) {
      console.error('Error updating board:', error);
    }
  }

  function saveCard(saveButton, columnId) {
    const cardElement = saveButton.closest('.card');
    const cardTitleInput = cardElement.querySelector('input');
    const cardTitle = cardTitleInput.value.trim(); // 입력된 텍스트 가져오기

    if (cardTitle !== '') {
      const cardText = document.createElement('p');
      cardText.textContent = cardTitle;

      fetch(`/api/column/${columnId}/card`, {
        credentials: 'same-origin',
        method: 'POST',
        body: JSON.stringify({ title: cardTitle }), // 객체를 JSON 문자열로 변환
        headers: {
          'Content-Type': 'application/json'
        },
      })
              .then(response => {
                if (response.statusCode == 201) {
                  alert('save card successfully');
                  // 여기서 다른 필요한 작업을 수행할 수 있습니다.
                }
              })
              .catch(error => {
                console.error('An error occurred:', error);
              });

      cardTitleInput.replaceWith(cardText); // 입력 필드 대신 텍스트 요소로 교체
      saveButton.remove(); // 버튼 삭제

      location.reload();
    }
  }

  function addCard(columnId) {
    const column = document.querySelector(`.list[id="${columnId}"]`);

    const newCard = document.createElement('div');
    newCard.className = 'card';

    const cardTitleInput = document.createElement('input');
    cardTitleInput.type = 'text';
    cardTitleInput.placeholder = 'Enter card title';

    const saveButton = document.createElement('button');
    saveButton.textContent = 'Save';
    saveButton.addEventListener('click', function() {
      saveCard(saveButton, columnId); // saveButton을 인자로 넘겨서 호출
    });

    newCard.appendChild(cardTitleInput);
    newCard.appendChild(saveButton);

    // "Add another card" 링크를 감싸는 div 요소 생성
    const addCardContainer = document.createElement('div');
    addCardContainer.className = 'add-card-container';

    // "Add another card" 링크를 div 요소 안으로 이동
    const addCardLink = column.querySelector('.btn-list');
    addCardContainer.appendChild(addCardLink);

    // 새로운 카드와 "Add another card" 링크를 순서대로 삽입
    column.appendChild(newCard);
    column.appendChild(addCardContainer);
  }

  function deleteCard(columnNo, cardNo) {
    fetch(`/api/column/${columnNo}/card/${cardNo}`, {
      credentials: 'same-origin',
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json'
      },
    })
            .then(response => {
              if (response.statusCode == 200) {
                alert('delete card successfully');
                // 여기서 다른 필요한 작업을 수행할 수 있습니다.
              }
              location.reload();
            })
            .catch(error => {
              console.error('An error occurred:', error);
            });
  }
</script>

</body>
</html>